name: Berg App Docker Build and Push
on:
  push:
    branches:
      - main
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        run: |
          docker build -t ajbergstedt/bergapp:latest .
      - name: Start container
        run: |
          docker run -d -p 80:80 --name bergapp_container ajbergstedt/bergapp:latest
          sleep 5
      - name: Check if app is running
        run: |
          docker ps -a | grep bergapp_container
      - name: Debug container logs
        run: |
          docker logs bergapp_container
      - name: Test endpoint response
        run: |
          curl -s http://localhost:80/ || echo "Failed to connect to endpoint"
      - name: Run liatrio/github-actions/apprentice-action@master
        uses: liatrio/github-actions/apprentice-action@master
      - name: Run fixed tests
        run: |
          echo "Running fixed tests (if any)"
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ajbergstedt
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
        if: success()
      - name: Push Docker image to Docker Hub
        run: |
          docker push ajbergstedt/bergapp:latest
        if: success()
      - name: Stop and remove container
        if: always()
        run: |
          docker stop bergapp_container || true
          docker rm bergapp_container || true